<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StoreCollect Payment</title>

  <!-- Yoco SDK -->
  <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>

  <!-- EmailJS (optional notifications) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("YOUR_EMAILJS_USER_ID"); 
  </script>
</head>
<body>
  <h1>Processing Your Payment...</h1>

  <script>
    // -------------------------------
    // 1️⃣ Capture query params
    // -------------------------------
    const params = new URLSearchParams(window.location.search);

    const product = {
      variantId: params.get("variantId"),
      quantity: parseInt(params.get("quantity")) || 1,
      shippingCost: parseFloat(params.get("shipping")) || 0,
    };

    // Customer info
    const firstName = params.get("firstName") || "John";
    const lastName = params.get("lastName") || "Doe";
    const email = params.get("email") || "customer@example.com";
    const phone = params.get("phone") || "";
    const address1 = params.get("address1") || "";
    const city = params.get("city") || "Other";
    const province = params.get("province") || "";
    const country = params.get("country") || "South Africa";
    const zip = params.get("zip") || "";

    // -------------------------------
    // 2️⃣ Init Yoco SDK (test key)
    // -------------------------------
    const yoco = new window.YocoSDK({
      publicKey: "pk_test_a3abafa43ol0djK02ad4"
    });

    // -------------------------------
    // 3️⃣ Open payment popup
    // -------------------------------
    async function processPayment() {
      const unitPrice = 199; // example product price in ZAR
      const totalAmount = product.quantity * unitPrice + product.shippingCost;
      const amountInCents = totalAmount * 100;

      console.log("💳 Charging R" + totalAmount, "(", amountInCents, "cents )");

      yoco.showPopup({
        amountInCents,
        currency: "ZAR",
        name: "StoreCollect",
        description: "Order Payment",
        callback: async (result) => {
          if (result.error) {
            console.error("❌ Yoco error:", result.error.message);
            alert("Payment failed: " + result.error.message);
            return;
          }

          console.log("✅ Yoco success:", result);

          // -------------------------------
          // 4️⃣ Send payload to Vercel webhook
          // -------------------------------
          const payload = {
            variantId: product.variantId,
            product_quantity: product.quantity,
            shipping_cost: product.shippingCost,
            customer_first_name: firstName,
            customer_last_name: lastName,
            customer_email: email,
            customer_phone: phone,
            customer_address: address1,
            customer_city: city,
            customer_province: province,
            customer_country: country,
            customer_zip: zip,
            payment_id: result.id, // real Yoco payment ID
            financial_status: "paid",
          };

          try {
            const response = await fetch(
              "https://storecollect-pay.vercel.app/api/yoco-webhook",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );

            if (!response.ok) {
              const errText = await response.text();
              throw new Error(errText);
            }

            const resultData = await response.json();
            console.log("✅ Shopify order created:", resultData);

            // Optional: EmailJS notification
            emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
              variant_id: product.variantId,
              quantity: product.quantity,
              shipping_cost: product.shippingCost.toFixed(2),
              customer_name: firstName + " " + lastName,
              customer_email: email,
              customer_phone: phone,
              customer_address: address1,
              customer_city: city,
              customer_province: province,
              customer_country: country,
              customer_zip: zip,
            });

            // Redirect to thank you page
            setTimeout(() => {
              window.location.href = "thank-you.html";
            }, 2000);

          } catch (err) {
            console.error("🔥 Webhook error:", err);
            alert("⚠ Payment succeeded but order creation failed. Contact support.");
          }
        },
      });
    }

    // Auto-run payment
    processPayment();
  </script>
</body>
</html>
