<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StoreCollect Payment</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("YOUR_USER_ID"); // replace with your EmailJS user ID
  </script>
</head>
<body>
  <h1>Processing Your Payment...</h1>

  <script>
    // -------------------------------
    // 1ï¸âƒ£ Capture query params
    // -------------------------------
    const params = new URLSearchParams(window.location.search);

    const product = {
      variantId: params.get("variantId"), // Shopify requires this
      quantity: parseInt(params.get("quantity")) || 1,
      shippingCost: parseFloat(params.get("shipping")) || 0,
    };

    // Collect customer info
    const firstName = params.get("firstName") || "John";
    const lastName = params.get("lastName") || "Doe";
    const email = params.get("email") || "customer@example.com";
    const phone = params.get("phone") || "";
    const address1 = params.get("address1") || "";
    const city = params.get("city") || "Other";
    const province = params.get("province") || "";
    const country = params.get("country") || "South Africa";
    const zip = params.get("zip") || "";

    // -------------------------------
    // 2ï¸âƒ£ Simple shipping calculation
    // -------------------------------
    function calculateShipping(city = "Other", country = "South Africa") {
      const saRates = {
        Johannesburg: 50,
        "Cape Town": 60,
        Durban: 55,
        Pretoria: 50,
        Other: 70,
      };
      if (country.toLowerCase() === "south africa")
        return saRates[city] || saRates["Other"];
      return 150; // international
    }
    product.shippingCost = calculateShipping(city, country);

    // -------------------------------
    // 3ï¸âƒ£ Send POST to Vercel webhook
    // -------------------------------
    async function sendToWebhook() {
      try {
        const payload = {
          variantId: product.variantId,
          product_quantity: product.quantity,
          shipping_cost: product.shippingCost,
          customer_first_name: firstName,
          customer_last_name: lastName,
          customer_email: email,
          customer_phone: phone,
          customer_address: address1,
          customer_city: city,
          customer_province: province,
          customer_country: country,
          customer_zip: zip,
          payment_id: "SIMULATED_PAYMENT_ID", // replace with Yoco real payment ID
          financial_status: "paid",
        };

        console.log("âž¡ Sending payload:", payload);

        const response = await fetch(
          "https://storecollect-pay.vercel.app/api/yoco-webhook",
          {
            method: "POST",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          }
        );

        console.log("â¬… Webhook response status:", response.status);

        if (!response.ok) throw new Error(await response.text());
        const result = await response.json();
        console.log("âœ… Webhook processed:", result);

        // -------------------------------
        // 4ï¸âƒ£ Send EmailJS notification
        // -------------------------------
        emailjs
          .send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
            variant_id: product.variantId,
            quantity: product.quantity,
            shipping_cost: product.shippingCost.toFixed(2),
            customer_name: firstName + " " + lastName,
            customer_email: email,
            customer_phone: phone,
            customer_address: address1,
            customer_city: city,
            customer_province: province,
            customer_country: country,
            customer_zip: zip,
          })
          .then(
            (response) => {
              console.log(
                "ðŸ“§ EmailJS sent:",
                response.status,
                response.text
              );
            },
            (error) => {
              console.error("âŒ EmailJS error:", error);
            }
          );

        // -------------------------------
        // 5ï¸âƒ£ Redirect to Thank You page
        // -------------------------------
        setTimeout(() => {
          window.location.href = "thank-you.html";
        }, 2000);
      } catch (err) {
        console.error("ðŸ”¥ Webhook error:", err);
        alert("âš  Payment failed or webhook error. Please contact support.");
      }
    }

    // Auto-run payment process
    sendToWebhook();
  </script>
</body>
</html>
       
